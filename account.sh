#!/bin/bash

#echo "항목 코드 U-01"

SECURETTY=/etc/securetty
SECURE=$(cat $SECURETTY | grep -i "pts" | wc -l)
SSH=/etc/ssh/sshd_config


if [ -e $SECURETTY ] && [ -e $SSH ]; then
        SSHD=$(cat $SSH | grep -E "PermitRootLogin yes|PermitRootLogin no" | awk '{print $2}')
        if [ $SECURE != 0 ] && [[ $SSHD == "yes" ]] ; then
                echo "U-01 취약 상" >> result.csv
        elif [ $SECURE -eq 0 ] && [[ $SSHD == "yes" ]] ; then
                echo "U-01 취약 상" >> result.csv
        else
                echo "U-01 양호 상" >> result.csv
        fi
else
        echo "U-01 점검 상" >> result.csv
fi

#echo "항목 코드 U-02"

PW=/etc/security
PWD=/etc/security/pwquality.conf
MIN=$(cat $PWD | grep "minlen" | awk '{print $4}')

if [ -e $PW ]; then
        if [[ ${MIN} -ge 8 ]]; then
                echo "U-02 양호 상" >> result.csv
        else
                echo "U-02 취약 상" >> result.csv
        fi
else
        echo "U-02 점검 상" >> result.csv
fi

#echo "항목 코드 U-03"

P=/etc/pam.d
PAM=/etc/pam.d/system-auth
PAMD=$(cat $PAM | grep "pam_tally.so" | grep "deny" | awk '{print $0}')

if [ -e $P ]; then
        if [[ "$PAMD" -le 10 ]]; then
                echo "U-03 양호 상" >> result.csv
        else
                echo "U-03 취약 상" >> resul.csv
        fi
else
        echo "U-03 점검 상" >> result.csv
fi

#echo "항목 코드 U-04"

PASSWD1=/etc/shadow
PASSWD2=/etc/passwd

if [ -e $PASSWD1 ]; then
        PASS=$(cat $PASSWD2 | grep "home" | awk -F: '{print $2}')
        if [ $PASS == "x" ]; then
                echo "U-04 양호 상" >> result.csv
        else
                echo "U-04 취약 상" >> result.csv
        fi
else
        echo "U-04 점검 상" >> result.csv
fi

#echo "항목 코드 U-44"
#echo "root 이외의 UID가 '0'금지"

DD=$(cat /etc/passwd | grep -v "root" | awk -F: '{print $1, $3}')

if [ "$DD" == *0* ]; then
        echo "U-44 양호 중" >> result.csv
else
        echo "U-44 취약 중" >> result.csv
fi

#echo "항목 코드 U-45"

W=/etc/group
WHL=$(cat $W | grep "wheel" | wc -l)
PWS=$(grep "pam_wheel.so" /etc/pam.d/su | grep -v '^#' | wc -l)

if [ -e $W ]; then
        if [ $WHL -eq 1 ]; then
                if [ $PWS -gt 0 ]; then
                        echo "U-45 양호 하" >> result.csv
                else
                        echo "U-45 취약 하" >> result.csv
                fi
        else
                echo "U-45 점검 하" >> result.csv
        fi
else
        echo "U-45 점검 하" >> result.csv
fi

#echo "항목 코드 U-46"

M=/etc/login.defs
MIN=$(cat $M | grep -v '^#' | grep "PASS_MIN_LEN" | awk '{print $2}')

if [ -e $M ]; then
        if [ $MIN -ge 8 ]; then
                echo "U-46 양호 중" >> result.csv
        else
                echo "U-46 취약 중" >> result.csv
        fi
else
        echo "U-46 점검 중" >> result.csv
fi

#echo "항목 코드 U-47"

L=/etc/login.defs
MAX=$(cat $L | grep -v '^#' | grep "PASS_MAX_DAYS" | awk '{print $2}')

if [ -e $L ]; then
        if [ $MAX -le 90 ]; then
                echo "U-47 양호 중" >> result.csv
        else
                echo "U-47 취약 중" >> result.csv
        fi
else
        echo "U-47 점검 중" >> result.csv
fi

#echo "항목 코드 U-48"

N=/etc/login.defs
MIND=$(cat $N | grep -v '^#' | grep "PASS_MIN_DAYS" | awk '{print $2}')

if [ -e $N ]; then
        if [ $MIND -ge 1 ];then
                echo "U-48 양호 중" >> result.csv
        else
                echo "U-48 취약 중" >> result.csv
        fi
else
        echo "U-48 점검 중" >> result.csv
fi

#echo "항목 코드 U-49"

DF=$(cat /etc/passwd | egrep "adm|lp|sync|shutdown|halt|news|mail|games|ftp|nobody|dbus|uucp|operator|squid"  | wc -l)

if [ $DF -eq 0 ]; then
        echo "U-49 양호 하" >> result.csv
else
        echo "U-49 취약 하" >> result.csv
fi

#echo "항목 코드 U-50"

G=/etc/group
GRP=$(cat $G | grep "root,")

if [ -e $G ]; then
        if [ -z $GRP ]; then
                echo "U-50 양호 하" >> result.csv
        else
                echo "U-50 취약 하" >> result.csv
        fi
else
        echo "U-50 점검 하" >> result.csv
fi

#echo "항목 코드 U-51"

GP=$(cat /etc/group | awk -F: '{print $3}')
PD=$(cat /etc/passwd | awk -F: '{print $4}')

if [ -e /etc/group -a -e /etc/passwd ]; then
        if [ "$GP" == "$PD" ]; then
                echo "U-51 양호 하" >> result.csv
        else
                echo "U-51 취약 하" >> result.csv
        fi
else
        echo "U-51 점검 하" >> result.csv
fi

#echo "항목 코드 U-52"

PAS=/etc/passwd
PASD=$(cat $PAS | awk -F: '{print $3}' | sort -n | uniq -d | wc -l)

if [ $PASD -gt 0 ]; then
        echo "U-52 취약 중" >> result.csv
else
        echo "U-52 양호 중" >> result.csv
fi

#echo "항목 코드 U-53"

NOLOG=$(cat /etc/passwd | egrep "^daemon|^bin|^sys|^adm|^listen|^nobody|^nobody4|^noaccess|^diag|^operator|^games|^gopher" | grep -v "admin" | awk -F: '{print $7}' | egrep -v "/sbin/nologin|/bin/false" | wc -l)


if [ $NOLOG -eq 0 ]; then
        echo "U-53 양호 하" >> result.csv
else
        echo "U-53 취약 하" >> result.csv
fi

#echo "항목 코드 U-54"

TM=$(cat /etc/profile | grep "TMOUT")
OUT=$($TM | awk -F= '{print $2}')

if [ -e /etc/profile ]; then
        if [ -z $TM ]; then
                echo "U-54 점검 하" >> result.csv
        else
                if [ $OUT -le 600 ]; then
                        echo "U-54 양호 하" >> result.csv
                else
                        echo "U-54 취약 하" >> result.csv
                fi
        fi
else
        echo "U-54 점검 하" >> result.csv
fi
